<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Face Mask Map</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.1/css/all.css">
    <style type="text/css">

    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDdRJiZqIKCiGsyuSW_TmR3hsORifUYcUc&callback=initMap&libraries=&v=weekly"
        defer></script>
    <link rel="stylesheet" href="style.css">

</head>

<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12 col-lg-4 position-relative">
                <div id="sidebar" class="w-100">
                    <div class="d-flex my-2 justify-content-between mt-2">
                        <div class="location d-flex flex-column">
                            <h2 class="mb-2 font-weight-bold">口罩查詢地圖</h2>
                            <div class="d-flex mb-2 mr-2">
                                <i class="fas fa-city"></i>
                                <select name="cities" id="cities" class="form-control">
                                    <option value="" selected disabled>選擇縣市</option>
                                </select>
                            </div>
                            <div class="d-flex mb-2 mr-2">
                                <i class="fas fa-building"></i>
                                <select name="area" id="area" class="form-control">
                                    <option value="" selected disabled>選擇區域</option>
                                </select>
                            </div>
                        </div>
                        <ul class="list-group">
                            <li class="list-group-item py-0"><img src="./green.png" alt="" ><span>大於1000</span></li>
                            <li class="list-group-item py-0"><img src="./yellow.png" alt="" >500~1000</li>
                            <li class="list-group-item py-0"><img src="./red.png" alt="" >小於500</li>
                          </ul>
                    </div>
                   
                    <hr>
                    <ul id="store-list"></ul>
                </div>
            </div>

            <div class="col-12 col-lg-8 my-1">
                <div id="map"></div>
                <span id="hb-btn" class="d-lg-none"><i class="fas fa-bars"></i></span>

            </div>
        </div>
    </div>

    <template id='cardTemplate'>
        <li>
            <div class="card border-warning mb-2 mr-2">
                <div class="card-header">
                    <span class="h5" id="shopName"></span>
                    <i class="fas fa-eye" data-lat="" data-lng=""></i>
                </div>
                <div class="card-body">
                    <p class="my-1 h5 text-danger"><span id="adult">成人口罩數量：</span></p>
                    <p class="my-1 h5 text-danger"><span id="child">兒童口罩數量：</span></p>
                    <p class="my-1 h6">
                        <i class="fas fa-map-marked-alt"></i>
                        <a target="_blank" href="" class="text-info" id="address"></a>
                    </p>
                    <p class="my-1 h6" id="phone"></p>
                    <div class="d-flex">
                        <p class="m-0" id="note"></p>
                    </div>
                </div>
            </div>
        </li>
    </template>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>

    <script>
        let maskData;
        const cities = document.querySelector('#cities');
        const area = document.querySelector('#area');
        const storeList = document.querySelector('#store-list');
        var gmarkers = [];//放所有的Marker

        function initMap() {
            var myLatLng = { lat: 25.0415956, lng: 121.5341098 },
                map = new google.maps.Map(document.getElementById("map"), {
                    center: myLatLng,
                    zoom: 15
                });
            getUserLocation(map);
            getMaskData(map, 'https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json');
            getCityData('./CityCountyData.json');
        }

        function getMaskData(map, url) {
            let xhr = new XMLHttpRequest();

            xhr.onload = function () {
                if (this.status == 200 && this.readyState == 4) {
                    maskData = JSON.parse(xhr.response);
                    renderPosition(map, maskData.features);

                    //設定群集資料
                    const clusterOptions = {
                        imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",
                        gridSize: 120, //群集網格內的像素數
                        zoomOnClick: true, //單擊時是否放大群集
                        maxZoom: 15, //始終顯示常規標記之前，您可以放大的最遠級別
                    };
                    var markerCluster = new MarkerClusterer(map, gmarkers, clusterOptions);
                    const styles = markerCluster.getStyles();
                    for (let i = 0; i < styles.length; i++) {
                        styles[i].textColor = "white";
                        styles[i].textSize = 18;
                    }

                    setOptionsEvent(maskData.features, map);
                    //setIconEvent(map);

                } else {
                    console.log('Error');
                }
            };
            xhr.open('GET', url);
            xhr.send();
        }

        //設置目前位置Maker
        function getUserLocation(map) {
            if (navigator.geolocation) {
                function showPosition(position) {
                    var myLatLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                    var marker = new google.maps.Marker({
                        position: myLatLng,
                        icon: 'http://maps.google.com/mapfiles/kml/pushpin/wht-pushpin.png',
                        map: map
                    });
                    map.setCenter(myLatLng);
                }
                function showError() {
                    console.log('無法取得你的地理位置。')
                }
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                console.log('你的裝置不支援定位功能。');
            }
        }

        function renderPosition(map, data) {
            data.forEach(x => {
                let count = x.properties.mask_adult + x.properties.mask_child;
                var marker;
                if (count <= 500) {
                    marker = new google.maps.Marker({
                        position: {
                            lat: x.geometry.coordinates[1], lng:
                                x.geometry.coordinates[0]
                        },
                        icon: "./red.png",
                        map: map
                    });
                    gmarkers.push(marker);
                }
                else if (count <= 1000) {
                    marker = new google.maps.Marker({
                        position: {
                            lat: x.geometry.coordinates[1], lng:
                                x.geometry.coordinates[0]
                        },
                        icon: "./yellow.png",
                        map: map
                    });
                    gmarkers.push(marker);
                }
                else {
                    marker = new google.maps.Marker({
                        position: {
                            lat: x.geometry.coordinates[1], lng:
                                x.geometry.coordinates[0]
                        },
                        icon: "./green.png",
                        map: map
                    });
                    gmarkers.push(marker);
                }

                const infowindow = new google.maps.InfoWindow({
                    // 設定想要顯示的內容
                    content: `<div class="infoWindow bg-light">
                                <h5 class="my-2">${x.properties.name}</h5>
                                <p class="my-1 h5 text-danger"><span>成人口罩數量：</span>${x.properties.mask_adult}</p>
                                <p class="my-1 h5 text-danger"><span>兒童口罩數量：</span>${x.properties.mask_child}</p>
                                <p class="my-1 h6">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <a target="_blank" href="https://www.google.com.tw/maps/place/${x.properties.address}" class="text-info">${x.properties.address}</a>
                                </p>                
                                <p class="my-1 h6"><i class="fas fa-phone-alt"></i>${x.properties.phone}</p>
                                <p class="my-1 h6"><i class="far fa-comment-alt"></i></i>${x.properties.note}</p>
                                <p class="my-1 h6 text-warning"><span>數據更新時間：</span>${x.properties.updated}</p>
                            </div>`,
                    // 設定訊息視窗最大寬度
                    maxWidth: 450
                });
                // 在地標上監聽點擊事件
                marker.addListener("click", () => {
                    // 指定在哪個地圖和地標上開啟訊息視窗
                    infowindow.open(this.map, marker);
                });
            });
        }

        function setOptionsEvent(data, map) {
            cities.addEventListener("change", function () {
                storeList.innerHTML = '';

                // data.forEach(item => {
                //     let itemValues = item.properties;
                //     let itemLocation = item.geometry.coordinates;

                //     if (itemValues.county == cities.value && itemValues.town == area.value) {

                //         let card = document.querySelector('#cardTemplate');
                //         let cloneContent = card.content.cloneNode(true);
                //         cloneContent.querySelector('#shopName').innerText = itemValues.name;
                //         cloneContent.querySelector('.fa-eye').setAttribute('data-lat', itemLocation[1]);
                //         cloneContent.querySelector('.fa-eye').setAttribute('data-lng', itemLocation[0]);
                //         cloneContent.querySelector('#adult').innerText = "成人口罩數量：" + itemValues.mask_adult;
                //         cloneContent.querySelector('#child').innerText = "兒童口罩數量：" + itemValues.mask_child;
                //         cloneContent.querySelector('#address').innerText = itemValues.name;
                //         cloneContent.querySelector('#address').setAttribute('href', `https://www.google.com.tw/maps/place/${itemValues.address}`);
                //         cloneContent.querySelector('#phone').innerHTML = '<i class="fas fa-phone-alt"></i>' + itemValues.phone;
                //         cloneContent.querySelector('#note').innerHTML = '<i class="far fa-comment-alt"></i>' + itemValues.note;
                //         cloneContent.querySelector('.fa-eye').addEventListener('click', function () {

                //         });
                //         storeList.append(cloneContent);
                //     }
                // })
            })

            area.addEventListener("change", function () {
                storeList.innerHTML = '';

                data.forEach(item => {
                    let itemValues = item.properties;
                    let itemLocation = item.geometry.coordinates;
                    if (itemValues.county == cities.value && itemValues.town == area.value) {

                        let card = document.querySelector('#cardTemplate');
                        let cloneContent = card.content.cloneNode(true);
                        cloneContent.querySelector('#shopName').innerText = itemValues.name;
                        cloneContent.querySelector('.fa-eye').setAttribute('data-lat', itemLocation[1]);
                        cloneContent.querySelector('.fa-eye').setAttribute('data-lng', itemLocation[0]);
                        cloneContent.querySelector('#adult').innerText = "成人口罩數量：" + itemValues.mask_adult;
                        cloneContent.querySelector('#child').innerText = "兒童口罩數量：" + itemValues.mask_child;
                        cloneContent.querySelector('#address').innerText = itemValues.name;
                        cloneContent.querySelector('#address').setAttribute('href', `https://www.google.com.tw/maps/place/${itemValues.address}`);
                        cloneContent.querySelector('#phone').innerHTML = '<i class="fas fa-phone-alt"></i>' + itemValues.phone;
                        cloneContent.querySelector('#note').innerHTML = '<i class="far fa-comment-alt"></i>' + itemValues.note;

                        //綁定icon事件
                        cloneContent.querySelector('.fa-eye').addEventListener('click', function () {
                            let newlat = Number(this.dataset.lat);
                            let newlng = Number(this.dataset.lng);
                            map.setCenter({ lat: newlat, lng: newlng });
                        })

                        storeList.append(cloneContent);
                    }
                })
            })
        }

        function getCityData(url) {
            let xhr = new XMLHttpRequest(); xhr.onload = function () {
                if (this.status == 200 && this.readyState == 4) {
                    let geoData = JSON.parse(this.response); let countriesOptions = ''; let cytiesOptions = '';
                    countriesOptions = `<option value="" selected disabled>選擇縣市</option>`;
                    geoData.forEach((item, index) => {
                        countriesOptions += `<option value="${item.CityName}">${item.CityName}</option>`;

                    })
                    cities.innerHTML = `<select name="" id="countries">${countriesOptions}</select>`;

                    cities.addEventListener('change', function () {
                        cytiesOptions = '';
                        cytiesOptions = `<option value="" selected disabled>選擇區域</option>`;
                        geoData[cities.selectedIndex - 1].AreaList.forEach(item => {
                            cytiesOptions += `<option value="${item.AreaName}">${item.AreaName}</option>`;
                        })
                        area.innerHTML = `<select name="" id="countries">${cytiesOptions}</select>`;
                    })
                } else {
                    console.log('Error');
                }
            };
            xhr.open('GET', url);
            xhr.send();
        }




    </script>
</body>

</html>